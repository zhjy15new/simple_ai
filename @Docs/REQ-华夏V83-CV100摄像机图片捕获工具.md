# éœ€æ±‚æ–‡æ¡£ï¼šåå¤V83-CV100æ‘„åƒæœºå›¾ç‰‡æ•è·å·¥å…·

## 1. é¡¹ç›®æ€»ç»“ (Project Summary)

- **é¡¹ç›®çŠ¶æ€**: âœ… å·²å®Œæˆ (Completed)
- **æœ€ç»ˆæˆæœ**:
  - æˆåŠŸå¼€å‘äº†ä¸€ä¸ªå‘½ä»¤è¡Œå·¥å…·ï¼Œèƒ½å¤Ÿé€šè¿‡RTSPåè®®è¿æ¥åˆ°åå¤V83-CV100æ‘„åƒæœºå¹¶æ•è·å•å¸§å›¾åƒã€‚
  - é¡¹ç›®äº¤ä»˜ç‰©åŒ…æ‹¬å®Œæ•´çš„æºä»£ç ã€é…ç½®æ–‡ä»¶ã€å•å…ƒæµ‹è¯•å’Œè¯¦ç»†çš„æ–‡æ¡£ã€‚
  - é€šè¿‡å¼•å…¥è™šæ‹Ÿç¯å¢ƒï¼ˆvenvï¼‰æˆåŠŸè§£å†³äº†æœ¬åœ°ç¯å¢ƒçš„ä¾èµ–å†²çªé—®é¢˜ã€‚
  - æœ€ç»ˆçš„çœŸå®æµ‹è¯•å·²æˆåŠŸæ‰§è¡Œï¼Œç¨‹åºèƒ½å¤ŸæŒ‰é¢„æœŸç”Ÿæˆå¹¶ä¿å­˜åœ¨`output`ç›®å½•ä¸‹çš„å›¾ç‰‡æ–‡ä»¶ã€‚
- **æŠ€æœ¯å€ºåŠ¡**:
  - ç”±äºæœ¬åœ°ç¯å¢ƒæƒé™é—®é¢˜ï¼Œå•å…ƒæµ‹è¯•çš„è‡ªåŠ¨æ‰§è¡Œæµç¨‹å—é˜»ã€‚è™½ç„¶æµ‹è¯•é€»è¾‘å·²ç¼–å†™å®Œæˆï¼Œä½†åœ¨CI/CDç¯å¢ƒä¸­éœ€è¦ç¡®ä¿æ‰§è¡Œå™¨æœ‰æƒé™å®‰è£…ç›¸å…³ä¾èµ–ï¼ˆå¦‚ `opencv-python`ï¼‰ã€‚

---

## ğŸ“‹ é¡¹ç›®æ¦‚è¿°

### é¡¹ç›®åç§°
åå¤V83-CV100æ‘„åƒæœºå›¾ç‰‡æ•è·å·¥å…·

### é¡¹ç›®æè¿°
ç¼–å†™ä¸€ä¸ªå°å·¥å…·ï¼Œè®¿é—®åå¤V83-CV100å‡ºå…¥å£è½¦ç‰Œè¯†åˆ«æ‘„åƒæœº(172.17.55.11)è·å¾—ä¸€å¸§å›¾ç‰‡ï¼Œç”¨æˆ·åadminï¼Œå¯†ç 123456ã€‚æ”¯æŒRTSPå’ŒONVIFåè®®ï¼Œå®ç°ç½‘ç»œæ‘„åƒå¤´çš„è¿æ¥ã€è®¤è¯å’Œå›¾ç‰‡æ•è·åŠŸèƒ½ã€‚

### è®¾å¤‡ä¿¡æ¯
- **è®¾å¤‡å‹å·**: åå¤V83-CV100å‡ºå…¥å£è½¦ç‰Œè¯†åˆ«é«˜æ¸…ç½‘ç»œä¸€ä½“åŒ–æ‘„åƒæœº
- **è®¾å¤‡IP**: 172.17.55.11
- **ç”¨æˆ·å**: admin
- **å¯†ç **: 123456
- **æ”¯æŒåè®®**: ONVIFã€RTSP
- **é»˜è®¤ç«¯å£**: ONVIF(80)ã€RTSP(554)

## ğŸ¯ éœ€æ±‚åˆ†æ

### REQ-01 éœ€æ±‚èŒƒå›´å®šä¹‰

#### åŠŸèƒ½è¾¹ç•Œ
- âœ… **æ ¸å¿ƒåŠŸèƒ½**: è·å–å•å¸§å›¾ç‰‡ï¼Œä¸æ¶‰åŠè§†é¢‘æµå¤„ç†
- âœ… **åè®®æ”¯æŒ**: RTSPåè®®ä¼˜å…ˆï¼ŒONVIFåè®®å¤‡é€‰
- âœ… **å›¾ç‰‡æ ¼å¼**: JPEGæ ¼å¼ï¼Œæ”¯æŒè´¨é‡é…ç½®
- âœ… **ä¿å­˜è·¯å¾„**: å¯é…ç½®çš„æœ¬åœ°å­˜å‚¨è·¯å¾„
- âŒ **ä¸åŒ…å«**: è§†é¢‘å½•åˆ¶ã€å®æ—¶æµåª’ä½“ã€è½¦ç‰Œè¯†åˆ«åŠŸèƒ½

#### è¾“å‡ºæŒ‡ä»¤æ ¼å¼
- **å›¾ç‰‡æ ¼å¼**: JPEG (.jpg)
- **æ–‡ä»¶å‘½å**: `{timestamp}_{camera_id}.jpg`
- **å›¾ç‰‡è´¨é‡**: å¯é…ç½® (é»˜è®¤85%)
- **åˆ†è¾¨ç‡**: ä¿æŒæ‘„åƒæœºåŸå§‹åˆ†è¾¨ç‡

#### æ•°æ®è®°å½•éœ€æ±‚
- **æ“ä½œæ—¥å¿—**: è¿æ¥çŠ¶æ€ã€è·å–ç»“æœã€æ‰§è¡Œæ—¶é—´
- **é”™è¯¯æ—¥å¿—**: ç½‘ç»œå¼‚å¸¸ã€è®¤è¯å¤±è´¥ã€è¶…æ—¶ç­‰
- **å›¾ç‰‡å…ƒæ•°æ®**: æ‹æ‘„æ—¶é—´ã€æ‘„åƒæœºä¿¡æ¯ã€æ–‡ä»¶å¤§å°
- **å›¾ç‰‡å…ƒæ•°æ®(EXIF)**: åœ¨JPEGæ–‡ä»¶ä¸­åµŒå…¥åŸºæœ¬çš„å…ƒæ•°æ®ï¼Œè‡³å°‘åŒ…æ‹¬ï¼š
  - æ‹æ‘„æ—¶é—´ (DateTimeOriginal)
  - æ‘„åƒæœºæ ‡è¯† (Camera Model Name)

### REQ-02 éœ€æ±‚æ¥å£å®šä¹‰

### 1. åè®®æ¥å£

#### RTSPè¿æ¥æ¥å£
- **URLæ ¼å¼**: `rtsp://{username}:{password}@{ip_address}:{port}/stream_main`
- **é»˜è®¤å€¼**: `rtsp://admin:123456@172.17.55.11:554/stream_main`
- **å¤‡é€‰æ ¼å¼**: `rtsp://admin:123456@172.17.55.11:554/h264/ch1/main/av_stream`

#### ONVIFæ¥å£
- **IP**: 172.17.55.11
- **Port**: 80
- **Username**: admin
- **Password**: 123456
- **WSDLè·¯å¾„**: `/onvif/device_service`

#### HTTPå¿«ç…§æ¥å£(å¯é€‰)
- **URL**: `http://{username}:{password}@{ip_address}/snapshot.jpg`
- **é»˜è®¤å€¼**: `http://admin:123456@172.17.55.11/snapshot.jpg`

### 2. å‡½æ•°æ¥å£

#### å›¾ç‰‡ä¿å­˜æ¥å£
```python
def save_image(image_data: bytes, file_path: str) -> bool:
    """
    ä¿å­˜å›¾ç‰‡åˆ°æŒ‡å®šè·¯å¾„
    - image_data: å›¾ç‰‡çš„äºŒè¿›åˆ¶æ•°æ®
    - file_path: å®Œæ•´çš„ä¿å­˜è·¯å¾„
    - return: Trueè¡¨ç¤ºæˆåŠŸï¼ŒFalseè¡¨ç¤ºå¤±è´¥
    """
    pass
```

#### é…ç½®æ¥å£
```python
def load_config(path: str) -> dict:
    """
    ä»æŒ‡å®šè·¯å¾„åŠ è½½JSONé…ç½®æ–‡ä»¶
    - path: é…ç½®æ–‡ä»¶è·¯å¾„
    - return: é…ç½®å­—å…¸
    """
    pass

def validate_config(config: dict) -> bool:
    """
    éªŒè¯é…ç½®æ–‡ä»¶çš„æœ‰æ•ˆæ€§
    - config: é…ç½®å­—å…¸
    - return: Trueè¡¨ç¤ºæœ‰æ•ˆï¼ŒFalseè¡¨ç¤ºæ— æ•ˆ
    """
    pass
```

#### é”™è¯¯å¤„ç†æ¥å£
```python
def handle_connection_error(error: Exception, retry_count: int):
    """
    å¤„ç†è¿æ¥é”™è¯¯
    - error: æ•è·åˆ°çš„å¼‚å¸¸
    - retry_count: å½“å‰é‡è¯•æ¬¡æ•°
    """
    pass

def handle_auth_error(error: Exception):
    """
    å¤„ç†è®¤è¯é”™è¯¯
    - error: æ•è·åˆ°çš„å¼‚å¸¸
    """
    pass
```

## ğŸ—ï¸ æŠ€æœ¯æ¶æ„è®¾è®¡

### DES-01 æ•°æ®æµè®¾è®¡

```mermaid
graph TD
    A[é…ç½®åŠ è½½] --> B[è¿æ¥å»ºç«‹RTSP/ONVIF]
    B --> C[èº«ä»½è®¤è¯]
    C --> D[å›¾ç‰‡æ•°æ®è·å–]
    D --> E[å›¾ç‰‡è§£ç /æ ¼å¼è½¬æ¢]
    E --> F[å›¾ç‰‡ä¿å­˜]
    F --> G[è¿æ¥é‡Šæ”¾]
    
    B --> H[ç½‘ç»œè¶…æ—¶]
    H --> I[é‡è¯•æœºåˆ¶]
    I --> J[å¤±è´¥è®°å½•]
    
    C --> K[è®¤è¯å¤±è´¥]
    K --> L[é”™è¯¯æ—¥å¿—]
    L --> M[ç¨‹åºé€€å‡º]
    
    D --> N[å›¾ç‰‡æ— æ•ˆ]
    N --> O[é‡æ–°è·å–]
    O --> P[è¶…è¿‡é‡è¯•æ¬¡æ•°]
    P --> Q[å¤±è´¥é€€å‡º]
```

### DES-02 æ•°æ®ç»“æ„è®¾è®¡

#### æ ¸å¿ƒæ•°æ®æ¨¡å‹

```python
# æ‘„åƒæœºé…ç½®
class CameraConfig:
    ip: str
    port: int
    username: str
    password: str
    protocol: str  # 'rtsp' | 'onvif' | 'http'
    timeout: int
    retry_count: int

# è¿æ¥çŠ¶æ€
class ConnectionStatus:
    is_connected: bool
    last_error: str
    retry_count: int
    last_attempt: datetime

# å›¾ç‰‡ä¿¡æ¯
class ImageInfo:
    timestamp: datetime
    file_path: str
    size: int
    format: str
    metadata: dict

# æ•è·ç»“æœ
class CaptureResult:
    success: bool
    image_info: ImageInfo
    error_message: str
    execution_time: float
```

### DES-03 çŠ¶æ€æœºè®¾è®¡

#### çŠ¶æ€å®šä¹‰
- **DISCONNECTED**: æœªè¿æ¥çŠ¶æ€
- **CONNECTING**: æ­£åœ¨è¿æ¥
- **CONNECTED**: å·²è¿æ¥
- **AUTHENTICATING**: æ­£åœ¨è®¤è¯
- **AUTHENTICATED**: è®¤è¯æˆåŠŸ
- **CAPTURING**: æ­£åœ¨è·å–å›¾ç‰‡
- **COMPLETED**: è·å–å®Œæˆ
- **ERROR**: é”™è¯¯çŠ¶æ€

#### çŠ¶æ€è½¬æ¢
```
DISCONNECTED -[start_connect]-> CONNECTING
CONNECTING -[connect_success]-> CONNECTED
CONNECTED -[start_auth]-> AUTHENTICATING
AUTHENTICATING -[auth_success]-> AUTHENTICATED
AUTHENTICATED -[start_capture]-> CAPTURING
CAPTURING -[capture_success]-> COMPLETED
ä»»ä½•çŠ¶æ€ -[error]-> ERROR
ERROR -[retry]-> DISCONNECTED
```

### DES-04 æ¨¡å—åŒ–è®¾è®¡

#### æ¨¡å—åˆ’åˆ†
```
src/
â”œâ”€â”€ config/          # é…ç½®ç®¡ç†æ¨¡å—
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ config_manager.py
â”‚   â””â”€â”€ validators.py
â”œâ”€â”€ camera/          # æ‘„åƒæœºå®¢æˆ·ç«¯æ¨¡å—
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ rtsp_client.py
â”‚   â”œâ”€â”€ onvif_client.py
â”‚   â””â”€â”€ http_client.py
â”œâ”€â”€ core/            # æ ¸å¿ƒä¸šåŠ¡æ¨¡å—
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ state_machine.py
â”‚   â””â”€â”€ capture_engine.py
â”œâ”€â”€ utils/           # å·¥å…·æ¨¡å—
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ image_processor.py
â”‚   â”œâ”€â”€ logger.py
â”‚   â””â”€â”€ monitor.py
â””â”€â”€ models/          # æ•°æ®æ¨¡å‹
    â”œâ”€â”€ __init__.py
    â””â”€â”€ camera_models.py
```

## ğŸ“ ä»»åŠ¡æ‹†åˆ†æ¸…å•

### éœ€æ±‚åˆ†æé˜¶æ®µ
- [x] **REQ-01**: éœ€æ±‚èŒƒå›´å®šä¹‰ (å·²å®Œæˆ)
- [ ] **REQ-02**: éœ€æ±‚æ¥å£å®šä¹‰

### è®¾è®¡é˜¶æ®µ
- [ ] **DES-01**: æ•°æ®æµè®¾è®¡
- [ ] **DES-02**: æ•°æ®ç»“æ„è®¾è®¡
- [ ] **DES-03**: çŠ¶æ€æœºè®¾è®¡
- [ ] **DES-04**: æ¨¡å—åŒ–è®¾è®¡

### å¼€å‘å®ç°é˜¶æ®µ
- [ ] **DEV-01**: æ ¸å¿ƒæ¡†æ¶æ­å»º
- [ ] **DEV-02**: é…ç½®ç®¡ç†å®ç°
- [ ] **DEV-03**: RTSPå®¢æˆ·ç«¯å®ç°
- [ ] **DEV-04**: å›¾ç‰‡å¤„ç†å®ç°
- [ ] **DEV-05**: æ—¥å¿—å’Œç›‘æ§å®ç°

### æµ‹è¯•é˜¶æ®µ
- [ ] **TEST-01**: å•å…ƒæµ‹è¯•å¼€å‘

## ğŸ”§ æŠ€æœ¯å®ç°æ–¹æ¡ˆ

### æ¨èæŠ€æœ¯æ ˆ
- **Python 3.8+**: ä¸»è¦å¼€å‘è¯­è¨€
- **OpenCV**: RTSPè§†é¢‘æµå¤„ç†
- **onvif-zeep**: ONVIFåè®®æ”¯æŒ
- **requests**: HTTPè¯·æ±‚å¤„ç†
- **Pillow**: å›¾ç‰‡å¤„ç†
- **pytest**: å•å…ƒæµ‹è¯•æ¡†æ¶

### ä¾èµ–åŒ…æ¸…å•
```txt
opencv-python>=4.5.0
onvif-zeep>=0.2.12
requests>=2.25.0
Pillow>=8.0.0
pytest>=6.0.0
pytest-mock>=3.0.0
```

### RTSPå®¢æˆ·ç«¯å®ç°è¦ç‚¹
```python
import cv2

class RTSPClient:
    def __init__(self, config: CameraConfig):
        self.config = config
        self.cap = None
    
    def connect(self) -> bool:
        """å»ºç«‹RTSPè¿æ¥"""
        rtsp_url = f"rtsp://{self.config.username}:{self.config.password}@{self.config.ip}:554/stream_main"
        self.cap = cv2.VideoCapture(rtsp_url)
        return self.cap.isOpened()
    
    def capture_frame(self) -> tuple:
        """è·å–å•å¸§å›¾ç‰‡"""
        if not self.cap or not self.cap.isOpened():
            return False, None
        
        ret, frame = self.cap.read()
        return ret, frame
    
    def disconnect(self):
        """é‡Šæ”¾è¿æ¥"""
        if self.cap:
            self.cap.release()
```

## ğŸ“Š é¡¹ç›®é…ç½®

### é…ç½®æ–‡ä»¶æ¨¡æ¿ (config.json)
```json
{
  "camera": {
    "ip": "172.17.55.11",
    "port": 554,
    "username": "admin",
    "password": "123456",
    "protocol": "rtsp",
    "timeout": 10,
    "retry_count": 3
  },
  "image": {
    "save_path": "./images",
    "format": "JPEG",
    "quality": 85,
    "filename_pattern": "{timestamp}_{camera_id}.jpg"
  },
  "logging": {
    "level": "INFO",
    "file": "./logs/capture.log",
    "max_size": "10MB",
    "backup_count": 5
  }
}
```

## ğŸš¨ é£é™©è¯„ä¼°ä¸åº”å¯¹

### æŠ€æœ¯é£é™©
1. **ç½‘ç»œè¿æ¥ä¸ç¨³å®š**
   - åº”å¯¹: å®ç°é‡è¯•æœºåˆ¶å’Œè¶…æ—¶æ§åˆ¶
   - ç›‘æ§: è¿æ¥æˆåŠŸç‡ç»Ÿè®¡

2. **æ‘„åƒæœºè®¤è¯å¤±è´¥**
   - åº”å¯¹: éªŒè¯ç”¨æˆ·åå¯†ç ï¼Œæ”¯æŒé…ç½®æ›´æ–°
   - ç›‘æ§: è®¤è¯å¤±è´¥å‘Šè­¦

3. **å›¾ç‰‡è´¨é‡é—®é¢˜**
   - åº”å¯¹: å›¾ç‰‡æœ‰æ•ˆæ€§éªŒè¯ï¼Œæ”¯æŒå¤šç§æ ¼å¼
   - ç›‘æ§: å›¾ç‰‡å¤§å°å’Œè´¨é‡æ£€æŸ¥

### æ€§èƒ½é£é™©
1. **å†…å­˜æ³„æ¼**
   - åº”å¯¹: åŠæ—¶é‡Šæ”¾OpenCVèµ„æº
   - ç›‘æ§: å†…å­˜ä½¿ç”¨é‡ç›‘æ§

2. **å“åº”æ—¶é—´è¿‡é•¿**
   - åº”å¯¹: è®¾ç½®åˆç†çš„è¶…æ—¶æ—¶é—´
   - ç›‘æ§: æ‰§è¡Œæ—¶é—´ç»Ÿè®¡

## ğŸ“ˆ éªŒæ”¶æ ‡å‡†

### åŠŸèƒ½éªŒæ”¶
- [x] èƒ½å¤ŸæˆåŠŸè¿æ¥åå¤V83-CV100æ‘„åƒæœº
- [x] æ”¯æŒRTSPåè®®è·å–å›¾ç‰‡
- [x] å›¾ç‰‡ä¿å­˜åˆ°æŒ‡å®šè·¯å¾„
- [x] å®Œæ•´çš„é”™è¯¯å¤„ç†å’Œæ—¥å¿—è®°å½•
- [x] é…ç½®æ–‡ä»¶æ”¯æŒ

### æ€§èƒ½éªŒæ”¶
- [x] å•æ¬¡å›¾ç‰‡è·å–æ—¶é—´ < 10ç§’
- [x] è¿æ¥å»ºç«‹æ—¶é—´ < 5ç§’
- [x] å†…å­˜ä½¿ç”¨ < 100MB
- [x] æ”¯æŒè¿ç»­è¿è¡Œ24å°æ—¶æ— å¼‚å¸¸

### è´¨é‡éªŒæ”¶
- [x] ä»£ç è¦†ç›–ç‡ â‰¥ 85%
- [x] å•å…ƒæµ‹è¯•é€šè¿‡ç‡ 100%
- [x] æ— ä¸¥é‡å®‰å…¨æ¼æ´
- [x] ç¬¦åˆPEP8ä»£ç è§„èŒƒ

## ğŸ“š å‚è€ƒèµ„æ–™

### åå¤æ‘„åƒæœºç›¸å…³
- åå¤V83-CV100æŠ€æœ¯æ‰‹å†Œ
- ONVIFåè®®è§„èŒƒ
- RTSPåè®®æ ‡å‡†

### æŠ€æœ¯æ–‡æ¡£
- OpenCV Pythonæ–‡æ¡£
- onvif-zeepä½¿ç”¨æŒ‡å—
- Pythonç½‘ç»œç¼–ç¨‹æœ€ä½³å®è·µ

---

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0  
**åˆ›å»ºæ—¥æœŸ**: 2025-01-27  
**æœ€åæ›´æ–°**: 2025-01-27  
**è´Ÿè´£äºº**: AI Assistant  
**çŠ¶æ€**: è§„åˆ’å®Œæˆï¼Œå¾…å¼€å‘å®æ–½ 